<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Encuesta Figura 01</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --brand:#2563eb; --bg:#0f172a; --fg:#e2e8f0; }
    html,body{height:100%;margin:0;background:#0b1220;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--fg)}
    .wrap{max-width:1100px;margin:0 auto;padding:1rem}
    header{position:sticky;top:0;background:var(--bg);z-index:100;display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;gap:.75rem;padding:.5rem 0 1rem;border-bottom:1px solid #1f2937}
    .logo-title{display:flex;align-items:center;gap:.5rem}
    .logo{height:2rem;width:auto;border-radius:4px;background-color:#ffffff;padding:0.25rem}
    header h1{font-size:1.1rem;margin:0;opacity:.9}
    .controls{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .timer-chip{font-size:.9rem;background:#111827;color:#cbd5e1;padding:.35rem .6rem;border:1px solid #1f2937;border-radius:999px}
    .btn{border:1px solid #334155;background:#0b1220;color:#e5e7eb;border-radius:999px;padding:.45rem .8rem;font-weight:600;cursor:pointer;transition:all 0.2s ease}
    .btn:hover:not(:disabled){background:#1e293b;border-color:#475569}
    .btn-primary{background:var(--brand);border-color:var(--brand);color:#fff}
    .btn-primary:hover:not(:disabled){background:#1d4ed8;border-color:#1d4ed8}
    .btn-large{padding:.7rem 1.5rem;font-size:1.1rem;min-width:120px}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .frame-box{aspect-ratio:9/14;width:100%;border-radius:16px;overflow:hidden;box-shadow:0 10px 40px rgba(0,0,0,.4);border:1px solid #1f2937}
    iframe{width:100%;height:100%;border:0;background:white}
    .modal-backdrop{position:fixed;inset:0;background:rgba(2,6,23,.65);display:none;align-items:center;justify-content:center;padding:1rem;z-index:9999}
    .modal{width:min(560px,92vw);background:#0b1328;border:1px solid #1f2a4a;border-radius:16px;box-shadow:0 10px 40px rgba(0,0,0,.5);overflow:hidden}
    .modal header{padding:1rem 1.25rem;background:#0e1730;border-bottom:1px solid #1f2a4a}
    .modal header h2{margin:0;font-size:1.1rem}
    .modal .content{padding:1rem 1.25rem;line-height:1.5}
    .modal .actions{display:flex;gap:.6rem;justify-content:space-between;padding:1rem 1.25rem;background:#0e1730;border-top:1px solid #1f2a4a}
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo-title">
        <img src="logo.png" alt="Logo" class="logo">
        <h1>Encuesta Colegios</h1>
      </div>

      <div class="controls" role="group" aria-label="Timer controls">
        <button class="btn btn-primary btn-large" id="startBtn">Iniciar</button>
        <button class="btn" id="pauseBtn" disabled>Pausar</button>
        <button class="btn" id="resetBtn">Reiniciar</button>
        <div class="timer-chip" id="status" aria-live="polite">
          <span id="count">60</span>
        </div>
      </div>
    </header>

    <div class="frame-box" role="region" aria-label="Survey form">
      <iframe
        id="surveyFrame"
        title="KoBo Survey"
        src="https://ee.kobotoolbox.org/x/27ZH7XRq"
        allow="geolocation *; camera *; microphone *"
        referrerpolicy="no-referrer-when-downgrade">
      </iframe>
    </div>

  </div>

  <!-- Modal -->
  <div class="modal-backdrop" id="backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <header>
        <h2 id="modalTitle">Es hora de tomar otra instant√°nea üì∑</h2>
      </header>
      <div class="content" id="modalBody">
        Por favor, agrega una nueva instant√°nea. Haz click en el "+" para continuar.
      </div>
      <div class="actions">
        <button class="btn" id="dismissOnce">Ya finaliz√≥ la clase</button>
        <button class="btn btn-primary" id="dismissAndSnooze">Reiniciar conteo</button>
      </div>
    </div>
  </div>

  <script>
    // === CONFIG ===
    const POPUP_AFTER_SECONDS = 300; // countdown duration
    const SNOOZE_SECONDS = 300;      // snooze after "Continue"

    // === STATE ===
    let remaining = POPUP_AFTER_SECONDS;
    let intervalId = null;
    let timerStarted = false;
    let timerStartTime = null;
    let lastVisibleTime = null;

     const countEl = document.getElementById('count');
     const startBtn = document.getElementById('startBtn');
     const pauseBtn = document.getElementById('pauseBtn');
     const resetBtn = document.getElementById('resetBtn');
     const backdrop = document.getElementById('backdrop');
     const dismissOnce = document.getElementById('dismissOnce');
     const dismissAndSnooze = document.getElementById('dismissAndSnooze');

    // === PERSISTENT TIMER FUNCTIONS ===
    function saveTimerState() {
      const timerState = {
        remaining: remaining,
        timerStarted: timerStarted,
        timerStartTime: timerStartTime,
        lastVisibleTime: Date.now()
      };
      localStorage.setItem('popKoboTimer', JSON.stringify(timerState));
    }

    function loadTimerState() {
      try {
        const saved = localStorage.getItem('popKoboTimer');
        if (saved) {
          const timerState = JSON.parse(saved);
          remaining = timerState.remaining;
          timerStarted = timerState.timerStarted;
          timerStartTime = timerState.timerStartTime;
          lastVisibleTime = timerState.lastVisibleTime;
          
          // Calculate elapsed time since last visibility
          if (timerStarted && timerStartTime && lastVisibleTime) {
            const now = Date.now();
            const elapsedSeconds = Math.floor((now - lastVisibleTime) / 1000);
            remaining = Math.max(0, remaining - elapsedSeconds);
            
            // Update UI
            countEl.textContent = remaining;
            
            // If timer should have finished, show modal
            if (remaining <= 0) {
              showModal();
              timerStarted = false;
              stopInterval();
              
              // Reset button states
              startBtn.disabled = false;
              pauseBtn.disabled = true;
              pauseBtn.textContent = 'Pausar';
            } else {
              // Resume timer if it was running and still has time
              timerStarted = true;
              intervalId = setInterval(tick, 1000);
              
              // Update button states
              startBtn.disabled = true;
              pauseBtn.disabled = false;
              pauseBtn.textContent = 'Pausar';
            }
          }
          
          return true;
        }
      } catch (error) {
        console.log('Could not load timer state:', error);
      }
      return false;
    }




    function startTimer() {
      if (timerStarted) return;
      timerStarted = true;
      timerStartTime = Date.now();
      lastVisibleTime = Date.now();
      stopInterval();
      intervalId = setInterval(tick, 1000);
      saveTimerState();
    }

    function stopInterval() {
      if (intervalId) clearInterval(intervalId);
      intervalId = null;
    }

    function resetTimer(seconds = POPUP_AFTER_SECONDS) {
      remaining = seconds;
      countEl.textContent = remaining;
      timerStarted = false;
      timerStartTime = null;
      lastVisibleTime = null;
      stopInterval();
      saveTimerState();
      console.log('Timer reset to', seconds, 'seconds');
    }

    // Function to clear all timer state (useful for testing)
    function clearTimerState() {
      localStorage.removeItem('popKoboTimer');
      console.log('Timer state cleared from localStorage');
    }

    // Test function to verify timer functionality
    function testTimer() {
      console.log('=== TIMER TEST ===');
      console.log('Current state:', {
        remaining: remaining,
        timerStarted: timerStarted,
        timerStartTime: timerStartTime,
        lastVisibleTime: lastVisibleTime
      });
      console.log('Saved state:', localStorage.getItem('popKoboTimer'));
      console.log('==================');
    }

    // Make test functions available globally for debugging
    window.testTimer = testTimer;
    window.clearTimerState = clearTimerState;

    function tick() {
      remaining -= 1;
      countEl.textContent = Math.max(remaining, 0);
      lastVisibleTime = Date.now();
      saveTimerState();
      
      if (remaining <= 0) {
        showModal();
        timerStarted = false;
        stopInterval();
        saveTimerState();
        
        // Reset button states
        startBtn.disabled = false;
        pauseBtn.disabled = true;
        pauseBtn.textContent = 'Pausar';
      }
    }

    function showModal() {
      backdrop.style.display = 'flex';
      backdrop.setAttribute('aria-hidden', 'false');
    }
    function hideModal() {
      backdrop.style.display = 'none';
      backdrop.setAttribute('aria-hidden', 'true');
    }


    dismissOnce.addEventListener('click', () => {
      hideModal();
      // Do not restart automatically
    });

    dismissAndSnooze.addEventListener('click', () => {
      hideModal();
      resetTimer(SNOOZE_SECONDS);
      startTimer();
      
      // Update button states
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      pauseBtn.textContent = 'Pausar';
    });

    // Button event listeners
    startBtn.addEventListener('click', () => {
      if (!timerStarted) {
        startTimer();
        startBtn.disabled = true;
        pauseBtn.disabled = false;
        pauseBtn.textContent = 'Pausar';
      }
    });

    pauseBtn.addEventListener('click', () => {
      if (timerStarted) {
        // Pause the timer
        timerStarted = false;
        stopInterval();
        pauseBtn.textContent = 'Reanudar';
        saveTimerState();
      } else {
        // Resume the timer
        timerStarted = true;
        timerStartTime = Date.now() - (POPUP_AFTER_SECONDS - remaining) * 1000;
        lastVisibleTime = Date.now();
        intervalId = setInterval(tick, 1000);
        pauseBtn.textContent = 'Pausar';
        saveTimerState();
      }
    });

    resetBtn.addEventListener('click', () => {
      resetTimer();
      startBtn.disabled = false;
      pauseBtn.disabled = true;
      pauseBtn.textContent = 'Pausar';
    });

    // Page visibility - handle persistent timer
    document.addEventListener('visibilitychange', () => {
      if (document.hidden) {
        // Page is hidden - save current state
        saveTimerState();
        stopInterval();
      } else {
        // Page is visible - load and resume timer
        if (loadTimerState()) {
          console.log('Timer state restored from localStorage');
        }
      }
    });

    // Save state when user navigates away
    window.addEventListener('beforeunload', () => {
      saveTimerState();
    });

    // Init
    console.log('Initializing timer...');
    if (!loadTimerState()) {
      // No saved state found, initialize with defaults
      console.log('No saved timer state found, initializing with defaults');
      resetTimer(POPUP_AFTER_SECONDS);
    } else {
      console.log('Timer state loaded from localStorage');
    }
  </script>
</body>
</html>